<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Movies!</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
  </head>
  <body>
    <h1>Movie Tiiiiiime!</h1>

    <script type="text/javascript">
      let rawData = "";
      let rawTitles = [];
      let titles = [];
      let rawLinks = [];
      let links = [];
      let rawImageUrls = [];
      let imageUrls = [];
      let rawSales = [];
      let sales = [];
      let rawWeekend = [];
      let weekend = [];
      let complete = [];
      let dataCollection  = [];

      let testImageUrls =[];

      $.get('https://cors-anywhere.herokuapp.com/http://www.imdb.com/chart/boxoffice', function(data) {

	      rawData = data.match(/<h1 class="header">[\s\S]*?<\/table>/g)[0];

        rawTitles = rawData.match(/ >.*?</g);
        titles = rawTitles.map(title => title.slice(2, -1))

        rawLinks = rawData.match(/href="\/title.*?"\n>/g);
        links = rawLinks.map(link => "http://www.imdb.com/" + link.slice(6, -3))

        rawImageUrls = rawData.match(/img src=".*?"/g);
        imageUrls = rawImageUrls.map(img => img.slice(9, -1));

        links.forEach(link => {
          $.get(`https://cors-anywhere.herokuapp.com/${link}`, function(data) {
            testImageUrls.push(data.match(/img alt=".*?"/g));
            // console.log(typeof(data));
          });
        });


        rawSales = rawData.match(/\$.*</g);
        sales = rawSales.map(sale  => parseFloat(sale.slice(1, -2)));

        complete = [titles, links, imageUrls, sales]

        for (var i = 0; i < 10; i++) {
          dataCollection[i] = {
                    titles: `${titles[i]}`,
                    links: `${links[i]}`,
                    imageUrls: `${imageUrls[i]}`,
                    sales: `${sales[i]}`
                  }
        }

        console.log(rawData);

// helpers
        const hoverText = d3.select("body").append("div")
          .attr("class", "hover")
          .text("hoverText");

  // dragging helpers
        function dragStart(d) {
          if (!d3.event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x, d.fy = d.y;
          d3.select(this).raise().classed("active", true);
        }

        function dragged(d) {
          d.fx = d3.event.x, d.fy = d3.event.y;
        }

        function dragOver(d) {
          if (!d3.event.active) simulation.alphaTarget(0);
          d.fx = null, d.fy = null;
          d3.select(this).classed("active", false);
        }
//d3 function
          let cirlces = null;
          let baseSize = 25;

          let width = 800;
          let height = 600;
          let forceStrength = 0.05;

          let center = {x: width/2, y: height/2};


        // (function(dataCollection) {
          var svg = d3.select("body").append("svg")
            .attr("id", "chart")
            .attr("width", width)
            .attr("height", height)
            // .append('g')
            // .attr("transform", "translate(0,0)")

          var simulation = d3.forceSimulation()
          .force("x", d3.forceX(center.x).strength(forceStrength))
          .force("y", d3.forceY(center.y).strength(forceStrength))
          .force("collide", d3.forceCollide(d => (d.sales / 3) + baseSize + 2))
          .on("tick", ticked); //KEY LINE FOR ACTIATION

          // d3.queue()
          //   .defer(d3.csv, "sales.csv")
            // .await(ready)


          // function ready (error, datapoints) {
            // var circles = svg.selectAll(".titles")
            //   .data(datapoints)
            //   .enter().append("rect")
            //   .attr("class", "titles")
            //   .attr("r", 10)
            //   .attr("fill", "lightblue");


            var circles = svg.selectAll(".circle") //circle element
              .data(dataCollection)
              .enter().append("circle")
              .attr("class", "circle")
              .attr("cx", d => center.x) // positions!
              .attr("cy", d => center.y)
              .attr("r", d => baseSize + (d.sales / 3))
              .attr("text", d => d.titles)
              .attr("fill", "lightgreen")
              .on("mouseover", (d,i) => { //mouseover hoverText
                hoverText.html(
                  `Name: ${d.titles}<br/>
                   Gross Sales: $${d.sales}M<br/>
                   Rank: ${i + 1} (based on weekend)<br/>`
                );
                hoverText.style("visibility", "visible");
              })
              .on("mousemove", () => {
                return hoverText
                  .style("top", (d3.event.pageY+10)+"px")
                  .style("left",(d3.event.pageX+10)+"px");
              })
              .on("mouseout", () => hoverText.style("visibility", "hidden"))
// DRAGGING CODE
              .call(d3.drag()
              .on("start", dragStart)
              .on("drag", dragged)
              .on("end", dragOver));


            // simulation.nodes(datapoints)
            //

// node stuff
            simulation.nodes(dataCollection)
              .on('tick', ticked)

            function ticked() {
              circles
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
            } // end ticked

          // } // end ready

        // }); // end wrap function

      }); //match to line 27 getJSON

    </script>
    <!-- <script src="bubble.js"></script> -->
  </body>
</html>
